- name: Build dynamic inventory from OpenTofu outputs
  hosts: localhost
  gather_facts: false
  vars:
    tofu_dir: "{{ playbook_dir }}/../opentofu"
  tasks:
    - name: Ensure OpenTofu directory exists
      stat:
        path: "{{ tofu_dir }}"
      register: tofu_dir_stat

    - name: Fail if OpenTofu dir not found
      fail:
        msg: "OpenTofu directory not found at {{ tofu_dir }}. Update tofu_dir to match your repo structure."
      when: not tofu_dir_stat.stat.exists

    - name: OpenTofu init (download providers for this job workspace)
      command: tofu -chdir={{ tofu_dir }} init -input=false -no-color
      register: tofu_init
      changed_when: false

    - name: Read OpenTofu outputs (JSON)
      command: tofu -chdir={{ tofu_dir }} output -json
      register: tf_out
      changed_when: false

    - name: Parse outputs
      set_fact:
        tf: "{{ tf_out.stdout | from_json }}"

    - name: Add hosts from OpenTofu output
      add_host:
        name: "{{ item.key }}"
        ansible_host: "{{ item.value.host }}"
        ansible_user: "{{ item.value.user | default('root') }}"
        ansible_port: "{{ item.value.port | default(22) }}"
        groups: tofu_hosts
      loop: "{{ tf.ansible_hosts.value | dict2items }}"

- name: Configure provisioned hosts
  hosts: tofu_hosts
  gather_facts: false
  become: true
  tasks:
    - name: Quick connectivity check
      ansible.builtin.ping:
